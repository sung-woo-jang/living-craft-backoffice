import { useState } from 'react'
import type { ServiceRegionInput, District } from '@/shared/types/api'
import { Button } from '@/shared/ui/button'
import { Input } from '@/shared/ui/input'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/shared/ui/select'
import { X, MapPin } from 'lucide-react'
import { useDistricts } from '../../api/use-districts'
import styles from './styles.module.scss'

interface RegionFeeSelectorProps {
  value: ServiceRegionInput[]
  onChange: (value: ServiceRegionInput[]) => void
}

export function RegionFeeSelector({ value, onChange }: RegionFeeSelectorProps) {
  const [selectedSido, setSelectedSido] = useState<number | null>(null)
  const [selectedSigungu, setSelectedSigungu] = useState<number | null>(null)
  const [estimateFee, setEstimateFee] = useState<string>('0')

  // 시/도 목록 조회
  const { data: sidoList = [] } = useDistricts({ level: 'SIDO' })

  // 선택된 시/도의 시/군/구 목록 조회
  const { data: sigunguList = [] } = useDistricts({
    level: 'SIGUNGU',
    parentId: selectedSido || undefined,
  })

  // 선택된 지역 정보 조회 (태그 표시용)
  const { data: allDistricts = [] } = useDistricts()

  const selectedRegions = value
    .map((region) => {
      const district = allDistricts.find((d) => d.id === region.districtId)
      return district ? { ...region, district } : null
    })
    .filter((r): r is ServiceRegionInput & { district: District } => r !== null)

  const handleAddRegion = () => {
    if (!selectedSido) {
      return
    }

    const fee = parseFloat(estimateFee)
    if (isNaN(fee) || fee < 0) {
      return
    }

    // Case 1: 특정 시/군/구 선택
    if (selectedSigungu) {
      // 중복 체크
      if (value.some((r) => r.districtId === selectedSigungu)) {
        return
      }
      onChange([...value, { districtId: selectedSigungu, estimateFee: fee }])
    }
    // Case 2: "전체 (시/도 전체)" 선택
    else {
      if (sigunguList.length === 0) {
        return
      }

      // 중복 체크: 이미 추가된 SIGUNGU ID 목록
      const existingDistrictIds = new Set(value.map((r) => r.districtId))

      // 중복되지 않은 SIGUNGU만 필터링
      const newRegions = sigunguList
        .filter((sigungu) => !existingDistrictIds.has(sigungu.id))
        .map((sigungu) => ({
          districtId: sigungu.id,
          estimateFee: fee,
        }))

      if (newRegions.length === 0) {
        return
      }

      onChange([...value, ...newRegions])
    }

    // 폼 초기화
    setSelectedSido(null)
    setSelectedSigungu(null)
    setEstimateFee('0')
  }

  const handleRemoveRegion = (districtId: number) => {
    onChange(value.filter((r) => r.districtId !== districtId))
  }

  return (
    <div className={styles.container}>
      {/* 선택된 지역 목록 */}
      {selectedRegions.length > 0 ? (
        <div className={styles.selectedRegions}>
          {selectedRegions.map((region) => (
            <div key={region.districtId} className={styles.regionTag}>
              <span className={styles.regionTagText}>
                <span className={styles.regionName}>
                  {region.district.name}
                </span>
                <span className={styles.regionFee}>
                  {region.estimateFee.toLocaleString()}원
                </span>
              </span>
              <button
                type='button'
                onClick={() => handleRemoveRegion(region.districtId)}
                className={styles.removeButton}
              >
                <X size={12} />
              </button>
            </div>
          ))}
        </div>
      ) : (
        <div className={styles.emptyState}>
          <MapPin size={24} />
          <p className={styles.emptyStateText}>선택된 서비스 지역이 없습니다</p>
          <p className={styles.emptyStateHint}>아래에서 지역을 추가해주세요</p>
        </div>
      )}

      {/* 지역 추가 폼 */}
      <div className={styles.addForm}>
        <div className={styles.selectRow}>
          <div className={styles.fieldGroup}>
            <label className={styles.label}>시/도</label>
            <Select
              value={selectedSido?.toString() || ''}
              onValueChange={(val) => {
                setSelectedSido(val ? parseInt(val) : null)
                setSelectedSigungu(null)
              }}
            >
              <SelectTrigger>
                <SelectValue placeholder='시/도 선택' />
              </SelectTrigger>
              <SelectContent>
                {sidoList.map((sido) => (
                  <SelectItem key={sido.id} value={sido.id.toString()}>
                    {sido.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className={styles.fieldGroup}>
            <label className={styles.label}>시/군/구 (선택)</label>
            <Select
              value={selectedSigungu?.toString() || '__ALL__'}
              onValueChange={(val) => {
                setSelectedSigungu(val === '__ALL__' ? null : parseInt(val))
              }}
              disabled={!selectedSido}
            >
              <SelectTrigger>
                <SelectValue
                  placeholder={selectedSido ? '전체' : '시/도를 먼저 선택'}
                />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value='__ALL__'>전체 (시/도 전체)</SelectItem>
                {sigunguList.map((sigungu) => (
                  <SelectItem key={sigungu.id} value={sigungu.id.toString()}>
                    {sigungu.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>

        <div className={styles.feeRow}>
          <div className={styles.feeInputWrapper}>
            <label className={styles.label}>출장비</label>
            <Input
              type='number'
              placeholder='0'
              value={estimateFee}
              onChange={(e) => setEstimateFee(e.target.value)}
              min='0'
              step='1000'
              className={styles.feeInput}
            />
            <span className={styles.feeSuffix}>원</span>
          </div>
          <Button
            type='button'
            onClick={handleAddRegion}
            disabled={!selectedSido || !estimateFee}
            variant='secondary'
            className={styles.addButton}
          >
            추가
          </Button>
        </div>
      </div>
    </div>
  )
}
